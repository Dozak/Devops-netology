# Домашнее задание к занятию "12.4 Развертывание кластера на собственных серверах, лекция 2"

Новые проекты пошли стабильным потоком. Каждый проект требует себе несколько кластеров: под тесты и продуктив. Делать все руками — не вариант, поэтому стоит автоматизировать подготовку новых кластеров.

## Задание 1: Подготовить инвентарь kubespray

Новые тестовые кластеры требуют типичных простых настроек. Нужно подготовить инвентарь и проверить его работу. Требования к инвентарю:
* подготовка работы кластера из 5 нод: 1 мастер и 4 рабочие ноды;
* в качестве CRI — containerd;
* запуск etcd производить на мастере.

### Ответ

Ограничен в ресурсах, поэтому создал 3 виртуалки с одинаковыми параметрами, засчет Vagrant: [Vagrantfile](/4%20блок/files/12.4/Vagrantfile)
Изменил файл [Inventory.ini](/4%20блок/files/12.4/cluster/inventory.ini)
Изменил файл [all.yml](/4%20блок/files/12.4/cluster/group_vars/all/all.yml)

```
ansible-playbook -i inventory/cluster/hosts.ini --become --become-user=root cluster.yml

PLAY RECAP *******************************************************************************************************************************************************************************************
localhost                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
node1                      : ok=707  changed=37   unreachable=0    failed=0    skipped=1323 rescued=0    ignored=7
node2                      : ok=456  changed=9    unreachable=0    failed=0    skipped=780  rescued=0    ignored=1
node3                      : ok=456  changed=9    unreachable=0    failed=0    skipped=780  rescued=0    ignored=1

Wednesday 08 June 2022  13:10:09 +0000 (0:00:00.070)       0:05:40.543 ********
===============================================================================
kubernetes/kubeadm : Join to cluster --------------------------------------------------------------------------------------------------------------------------------------------------------- 36.08s
download : download_file | Validate mirrors -------------------------------------------------------------------------------------------------------------------------------------------------- 22.81s
kubernetes/control-plane : kubeadm | Initialize first master --------------------------------------------------------------------------------------------------------------------------------- 16.05s
kubernetes/preinstall : Update package management cache (APT) -------------------------------------------------------------------------------------------------------------------------------- 11.69s
network_plugin/calico : Wait for calico kubeconfig to be created ----------------------------------------------------------------------------------------------------------------------------- 11.30s
kubernetes/control-plane : Master | wait for kube-scheduler ----------------------------------------------------------------------------------------------------------------------------------- 6.54s
kubernetes-apps/ansible : Kubernetes Apps | Start Resources ----------------------------------------------------------------------------------------------------------------------------------- 3.85s
network_plugin/calico : Get current calico cluster version ------------------------------------------------------------------------------------------------------------------------------------ 3.70s
network_plugin/calico : Get current calico cluster version ------------------------------------------------------------------------------------------------------------------------------------ 3.43s
kubernetes-apps/ansible : Kubernetes Apps | Lay Down CoreDNS templates ------------------------------------------------------------------------------------------------------------------------ 3.24s
network_plugin/calico : Calico | Configure calico FelixConfiguration -------------------------------------------------------------------------------------------------------------------------- 2.22s
network_plugin/calico : Start Calico resources ------------------------------------------------------------------------------------------------------------------------------------------------ 2.21s
network_plugin/calico : Calico | Create calico manifests -------------------------------------------------------------------------------------------------------------------------------------- 1.96s
container-engine/containerd : containerd | Unpack containerd archive -------------------------------------------------------------------------------------------------------------------------- 1.95s
network_plugin/calico : Calico | Create ipamconfig resources ---------------------------------------------------------------------------------------------------------------------------------- 1.82s
container-engine/validate-container-engine : Populate service facts --------------------------------------------------------------------------------------------------------------------------- 1.73s
container-engine/crictl : extract_file | Unpacking archive ------------------------------------------------------------------------------------------------------------------------------------ 1.59s
container-engine/runc : download_file | Validate mirrors -------------------------------------------------------------------------------------------------------------------------------------- 1.58s
container-engine/containerd : download_file | Validate mirrors -------------------------------------------------------------------------------------------------------------------------------- 1.47s
container-engine/nerdctl : download_file | Validate mirrors ----------------------------------------------------------------------------------------------------------------------------------- 1.46s
```

```
root@node1:/home/vagrant# kubectl get nodes
NAME    STATUS   ROLES                  AGE     VERSION
node1   Ready    control-plane,master   4m31s   v1.23.7
node2   Ready    <none>                 3m32s   v1.23.7
node3   Ready    <none>                 3m32s   v1.23.7
```
